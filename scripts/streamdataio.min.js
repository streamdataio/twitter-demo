(function(b){function c(e,f,a){var b=window.location.origin;this.cancelable=this.cancelBubble=this.bubbles=!1;this.data=f||null;this.origin=b||"";this.lastEventId=a||"";this.type=e||"message"}if(!b.EventSource||b.ja){var d=(b.ja||"")+"EventSource",g=function(e,f){if(!e||"string"!=typeof e)throw new SyntaxError("Not enough arguments");this.URL=e;this.Ba(f);var a=this;setTimeout(function(){a.Y()},0)};g.prototype={CONNECTING:0,OPEN:1,CLOSED:2,R:{X:!1,sa:"eventsource",interval:500,la:262144,D:3E5,u:{},
aa:{Accept:"text/event-stream","Cache-Control":"no-cache","X-Requested-With":"XMLHttpRequest"}},Ba:function(e){var f=this.R,a;for(a in f)f.hasOwnProperty(a)&&(this[a]=f[a]);for(a in e)a in f&&e.hasOwnProperty(a)&&(this[a]=e[a]);if("undefined"===typeof console||"undefined"===typeof console.log)this.X=!1},log:function(e){this.X&&console.log("["+this.sa+"]:"+e)},Y:function(){try{this.readyState!=this.CLOSED&&(this.P(),this.readyState=this.CONNECTING,this.cursor=0,this.C="",this.i=new this.o(this),this.Z())}catch(e){this.log("There were errors inside the pool try-catch"),
this.dispatchEvent("error",{type:"error",data:e.message})}},v:function(e){var f=this;f.readyState=f.CONNECTING;f.dispatchEvent("error",{type:"error",data:"Reconnecting "});this.s=setTimeout(function(){f.Y()},e||0)},P:function(){this.log("evs cleaning up");this.s&&(clearInterval(this.s),this.s=null);this.l&&(clearInterval(this.l),this.l=null);this.i&&(this.i.abort(),this.i=null)},Z:function(){if(this.D){this.l&&clearInterval(this.l);var e=this;this.l=setTimeout(function(){e.log("Timeout! silentTImeout:"+
e.D);e.v()},this.D)}},close:function(){this.readyState=this.CLOSED;this.log("Closing connection. readyState: "+this.readyState);this.P()},A:function(){var e=this.i;if(e.W()&&!e.U()){this.Z();this.readyState==this.CONNECTING&&(this.readyState=this.OPEN,this.dispatchEvent("open",{type:"open"}));var f=e.T();f.length>this.la&&(this.log("buffer.length > this.bufferSizeLimit"),this.v());0==this.cursor&&0<f.length&&"\ufeff"==f.substring(0,1)&&(this.cursor=1);var a=this.ra(f);a[0]>=this.cursor&&(a=a[1],this.za(f.substring(this.cursor,
a)),this.cursor=a);e.V()&&(this.log("request.isDone(). reopening the connection"),this.v(this.interval))}else this.readyState!==this.CLOSED&&(this.log("this.readyState !== this.CLOSED"),this.v(this.interval))},za:function(e){e=this.C+this.ta(e);e=e.split("\n\n");var a,n,b,g,d;for(a=0;a<e.length-1;a++){b="message";g=[];parts=e[a].split("\n");for(n=0;n<parts.length;n++)d=this.Ca(parts[n]),0==d.indexOf("event")?b=d.replace(/event:?\s*/,""):0==d.indexOf("retry")?(d=parseInt(d.replace(/retry:?\s*/,"")),
isNaN(d)||(this.interval=d)):0==d.indexOf("data")?g.push(d.replace(/data:?\s*/,"")):0==d.indexOf("id:")?this.lastEventId=d.replace(/id:?\s*/,""):0==d.indexOf("id")&&(this.lastEventId=null);g.length&&this.dispatchEvent(b,new c(b,g.join("\n"),this.lastEventId))}this.C=e[e.length-1]},dispatchEvent:function(e,a){var b=this["_"+e+"Handlers"];if(b)for(var c=0;c<b.length;c++)b[c].call(this,a);this["on"+e]&&this["on"+e].call(this,a)},addEventListener:function(e,a){this["_"+e+"Handlers"]||(this["_"+e+"Handlers"]=
[]);this["_"+e+"Handlers"].push(a)},s:null,i:null,lastEventId:null,C:"",cursor:0,readyState:0,$:function(e,a){var b=[];if(a){var c,d,g=encodeURIComponent;for(c in a)a.hasOwnProperty(c)&&(d=g(c)+"="+g(a[c]),b.push(d))}return 0<b.length?-1==e.indexOf("?")?e+"?"+b.join("&"):e+"&"+b.join("&"):e},ra:function(e){var a=e.lastIndexOf("\n\n"),b=e.lastIndexOf("\r\r");e=e.lastIndexOf("\r\n\r\n");return e>Math.max(a,b)?[e,e+4]:[Math.max(a,b),Math.max(a,b)+2]},Ca:function(a){return a.replace(/^(\s|\u00A0)+|(\s|\u00A0)+$/g,
"")},ta:function(a){return a.replace(/\r\n|\r/g,"\n")}};if(window.XDomainRequest&&window.XMLHttpRequest&&void 0===(new XMLHttpRequest).responseType){g.g="IE_8-9";var a=g.prototype.R;a.aa=null;a.u.evs_preamble=2056;g.prototype.o=function(a){this.b=request=new XDomainRequest;request.onprogress=function(){request.M=!0;a.A()};request.onload=function(){this.I=!0;a.A()};request.onerror=function(){this.h=!0;a.readyState=a.CLOSED;a.dispatchEvent("error",{type:"error",data:"XDomainRequest error"})};request.ontimeout=
function(){this.h=!0;a.readyState=a.CLOSED;a.dispatchEvent("error",{type:"error",data:"XDomainRequest timed out"})};var f={};if(a.u){var b=a.u,c;for(c in b)b.hasOwnProperty(c)&&(f[c]=b[c]);a.lastEventId&&(f.evs_last_event_id=a.lastEventId)}request.open("GET",a.$(a.URL,f));request.send()};g.prototype.o.prototype={b:null,M:!1,I:!1,h:!1,W:function(){return this.b.M},V:function(){return this.b.I},U:function(){return this.b.h},T:function(){var a="";try{a=this.b.responseText||""}catch(b){}return a},abort:function(){this.b&&
this.b.abort()}}}else g.g="XHR",g.prototype.o=function(a){this.b=request=new XMLHttpRequest;a.i=this;request.onreadystatechange=function(){1<request.readyState&&a.readyState!=a.CLOSED&&(200==request.status||300<=request.status&&400>request.status?a.A():(request.h=!0,a.readyState=a.CLOSED,a.dispatchEvent("error",{type:"error",data:"The server responded with "+request.status}),a.close()))};request.onprogress=function(){};request.open("GET",a.$(a.URL,a.u),!0);var b=a.aa,c;for(c in b)b.hasOwnProperty(c)&&
request.setRequestHeader(c,b[c]);a.lastEventId&&request.setRequestHeader("Last-Event-Id",a.lastEventId);request.send()},g.prototype.o.prototype={b:null,h:!1,W:function(){return 2<=this.b.readyState},V:function(){return 4==this.b.readyState},U:function(){return this.h||400<=this.b.status},T:function(){var a="";try{a=this.b.responseText||""}catch(b){}return a},abort:function(){this.b&&this.b.abort()}};b[d]=g}})(this);var h={g:function(b,c,d){c=c.split(".");for(var g=0;g<c.length-1;g++)b=b[c[g]];this.a(b,c[c.length-1],d)},a:function(b,c,d){b[c]=d}};var Logger=function(){function b(b,a){return b.replace(/{(\d+)}/g,function(b,f){var d;if(a[f]&&"object"===typeof a[f]&&a[f]instanceof Error)try{d=a[f].message,a[f].stack&&c.error(a[f].stack)}catch(g){d=a[f]}else if(a[f]&&"object"===typeof a[f])try{a[f].toString!==Object.prototype.toString?d=a[f].toString():d=JSON.stringify(a[f])}catch(l){d=a[f]}else a[f]&&"function"===typeof a[f]?d="function":d=a[f]?a[f]:b;d=""+d;return d.substring(0,Math.min(500,d.length))})}var c=window.console,d=2;return{ba:3,
ca:2,da:1,ERROR:0,Aa:function(b){d=b},debug:function(){3<=d&&c&&c.log&&c.log(b(arguments[0],Array.prototype.slice.call(arguments,1)))},info:function(){2<=d&&c&&c.info&&c.info(b(arguments[0],Array.prototype.slice.call(arguments,1)))},warn:function(){1<=d&&c&&c.warn&&c.warn(b(arguments[0],Array.prototype.slice.call(arguments,1)))},error:function(){0<=d&&c&&c.error&&c.error(b(arguments[0],Array.prototype.slice.call(arguments,1)))}}}();var Preconditions=function(b){return{c:function(b,d){if("undefined"===typeof b||null===b){if(d)throw Error(d);throw Error("value cannot be null");}return b},g:function(c,d){this.c(c,"functionName cannot be null");this.c(d,"message cannot be null");b.warn("Deprecated: function '{0}' is deprecated because '{1}'.",c,d)},na:function(b,d){if(!b){if(d)throw Error(d);throw Error("expression is not valid");}},ma:function(b,d){if(!b){if(d)throw Error(d);throw Error("expression is not valid");}}}}(Logger);function m(b){Preconditions.c(b,"bind cannot be null");this.ea=b;this.w=[]}m.prototype={m:function(){for(var b=this.w.slice(),c=0,d=b.length;c<d;c++)try{var g=b[c];g&&g.apply(this.ea,arguments)}catch(a){Logger.error("Unable to forward event: {0}",a)}},add:function(b){Preconditions.c(b,"listener cannot be null");Preconditions.na(-1==this.w.indexOf(b),"listener already exists");this.w.push(b)}};function StreamdataEventSource(b,c,d,g){Preconditions.c(b,"url cannot be null.");Preconditions.c(c,"appToken cannot be null.");Preconditions.ma(null===g||void 0===g||g.hasOwnProperty("signUrl"),"authStrategy does not implement signUrl() function.");d=d||[];g=void 0===g?null:g;var a=this;a.streamdataConfig={PROTOCOL:"https://",HOST:"streamdata.motwin.net",PORT:""};a.f=null;a.j=!1;a.B=b;a.K=new m(a);a.F=new m(a);a.L=new m(a);a.H=new m(a);a.J=new m(a);a.ka=d;a.G={type:"UnknownError",status:1E3,message:"An error occured. Please check your console logs for more details.",
source:"server"};a.open=function(){Preconditions.c(a.B,"url cannot be null");a.close();var b=a.ia(a.B,a.ka);b&&(a.f=new EventSource(b),a.f.addEventListener("open",function(b){Logger.debug("SSE Stream Opened to "+a.B+"event: "+JSON.stringify(b));a.j=!0;a.K.m()}),a.f.addEventListener("error",function(b){Logger.debug("Error with SSE at "+b+": closing the stream.");a.f.close();a.j=!1;a.H.m(a.fa(b))}),a.f.addEventListener("data",function(b){Logger.debug("Received data:"+b.data);a.F.m(JSON.parse(b.data))}),
a.f.addEventListener("patch",function(b){Logger.debug("Received patch:"+b.data);a.L.m(JSON.parse(b.data))}),a.f.addEventListener("monitor",function(b){Logger.debug("Received monitor:"+b.data);a.J.m(JSON.parse(b.data))}));return this};a.close=function(){a.j&&null!==a.f&&(Logger.info("Closing the SSE Stream."),a.f.close(),a.j=!1);return this};a.ia=function(b,d){Preconditions.c(b,"url cannot be null");d=d||[];var c=document.createElement("a");c.href=b;var k=/\/\/(.*@)/g.exec(b),k=k?k=k[1]:"",c=c.protocol+
"//"+k+c.hostname+(0==c.pathname.indexOf("/")?"":"/")+c.pathname+c.search,c=null===g?c:g.signUrl(c),k=a.ha(d),l="";0<k.length&&(l=document.createElement("a"),l.href=c,l=(-1===l.search.indexOf("?")?"?":"&")+k.join("&"));c=a.streamdataConfig.PROTOCOL+a.streamdataConfig.HOST+(a.qa(a.streamdataConfig.PORT)?"":":")+a.streamdataConfig.PORT+"/"+c+l;Logger.debug("converted url :"+c);return c};a.ha=function(b){b=b||[];b=a.ga(b);b.push("X-Sd-Token="+encodeURIComponent(c));return b};a.ga=function(a){a=a||[];
return a.map(function(a){return"X-Sd-Header="+encodeURIComponent(a)})};a.fa=function(b){Preconditions.c(b,"event cannot be null");var c=a.G;try{var d=JSON.parse(b.data);c.type=d.cause;c.message=d.message;c.status=d.status}catch(g){c=a.G}c.source="server";console.log(JSON.stringify(c));return new StreamdataError(c.type,c.message,c.status,c.source,!0)};a.qa=function(a){return!a||0===a.length}}
StreamdataEventSource.prototype={xa:function(b){Preconditions.c(b,"listener cannot be null");this.K.add(b);return this},va:function(b){Preconditions.c(b,"listener cannot be null");this.H.add(b);return this},ua:function(b){Preconditions.c(b,"listener cannot be null");this.F.add(b);return this},ya:function(b){Preconditions.c(b,"listener cannot be null");this.L.add(b);return this},wa:function(b){Preconditions.c(b,"listener cannot be null");this.J.add(b);return this},pa:function(){return this.j}};function StreamdataError(b,c,d,g,a){this.g=g;this.S=b;this.N=c;this.oa=a||!1;this.O=d;h.a(this,"source",this.g);h.a(this,"type",this.S);h.a(this,"message",this.N);h.a(this,"status",this.O)}StreamdataError.prototype={isFatal:function(){return this.oa},isServer:function(){return"server"==this.g},isClient:function(){return"client"==this.g},getMessage:function(){return this.N},getStatus:function(){return this.O},getType:function(){return this.S}};var streamdataio=new function(){};h.a(streamdataio,"Logger",Logger);h.a(Logger,"DEBUG",Logger.ba);h.a(Logger,"INFO",Logger.ca);h.a(Logger,"WARN",Logger.da);h.a(Logger,"ERROR",Logger.ERROR);h.a(Logger,"setLevel",Logger.Aa);h.a(Logger,"debug",Logger.debug);h.a(Logger,"info",Logger.info);h.a(Logger,"warn",Logger.warn);h.a(Logger,"error",Logger.error);
h.a(streamdataio,"createEventSource",function(b,c,d,g){Preconditions.c(b,"url cannot be null");c=c||[];g=g||null;0!=b.lastIndexOf("http://",0)&&0!=b.lastIndexOf("https://",0)&&(b="http://"+b,Logger.warn("url has no default protocol defined. Add http:// as a default protocol."));return new StreamdataEventSource(b,c,d,g)});h.a(StreamdataError.prototype,"isFatal",StreamdataError.prototype.isFatal);h.a(StreamdataError.prototype,"isServer",StreamdataError.prototype.isServer);
h.a(StreamdataError.prototype,"isClient",StreamdataError.prototype.isClient);h.a(StreamdataError.prototype,"getMessage",StreamdataError.prototype.getMessage);h.a(StreamdataError.prototype,"getStatus",StreamdataError.prototype.getStatus);h.a(StreamdataError.prototype,"getType",StreamdataError.prototype.getType);h.a(StreamdataEventSource.prototype,"open",StreamdataEventSource.prototype.connect);h.a(StreamdataEventSource.prototype,"onOpen",StreamdataEventSource.prototype.xa);
h.a(StreamdataEventSource.prototype,"onError",StreamdataEventSource.prototype.va);h.a(StreamdataEventSource.prototype,"onData",StreamdataEventSource.prototype.ua);h.a(StreamdataEventSource.prototype,"onPatch",StreamdataEventSource.prototype.ya);h.a(StreamdataEventSource.prototype,"onMonitor",StreamdataEventSource.prototype.wa);h.a(StreamdataEventSource.prototype,"isConnected",StreamdataEventSource.prototype.pa);
