(function(b){function e(f,d,g){var a=window.location.origin;this.cancelable=this.cancelBubble=this.bubbles=!1;this.data=d||null;this.origin=a||"";this.lastEventId=g||"";this.type=f||"message"}if(!b.EventSource||b.ia){var c=(b.ia||"")+"EventSource",h=function(f,d){if(!f||"string"!=typeof f)throw new SyntaxError("Not enough arguments");this.URL=f;this.Aa(d);var a=this;setTimeout(function(){a.X()},0)};h.prototype={CONNECTING:0,OPEN:1,CLOSED:2,P:{W:!1,ra:"eventsource",interval:500,ka:262144,C:3E5,u:{},
$:{Accept:"text/event-stream","Cache-Control":"no-cache","X-Requested-With":"XMLHttpRequest"}},Aa:function(f){var d=this.P,a;for(a in d)d.hasOwnProperty(a)&&(this[a]=d[a]);for(a in f)a in d&&f.hasOwnProperty(a)&&(this[a]=f[a]);if("undefined"===typeof console||"undefined"===typeof console.log)this.W=!1},log:function(f){this.W&&console.log("["+this.ra+"]:"+f)},X:function(){try{this.readyState!=this.CLOSED&&(this.O(),this.readyState=this.CONNECTING,this.cursor=0,this.cache="",this.i=new this.o(this),
this.Y())}catch(f){this.log("There were errors inside the pool try-catch"),this.dispatchEvent("error",{type:"error",data:f.message})}},v:function(f){var d=this;d.readyState=d.CONNECTING;d.dispatchEvent("error",{type:"error",data:"Reconnecting "});this.s=setTimeout(function(){d.X()},f||0)},O:function(){this.log("evs cleaning up");this.s&&(clearInterval(this.s),this.s=null);this.l&&(clearInterval(this.l),this.l=null);this.i&&(this.i.abort(),this.i=null)},Y:function(){if(this.C){this.l&&clearInterval(this.l);
var f=this;this.l=setTimeout(function(){f.log("Timeout! silentTImeout:"+f.C);f.v()},this.C)}},close:function(){this.readyState=this.CLOSED;this.log("Closing connection. readyState: "+this.readyState);this.O()},A:function(){var f=this.i;if(f.V()&&!f.T()){this.Y();this.readyState==this.CONNECTING&&(this.readyState=this.OPEN,this.dispatchEvent("open",{type:"open"}));var d=f.S();d.length>this.ka&&(this.log("buffer.length > this.bufferSizeLimit"),this.v());0==this.cursor&&0<d.length&&"\ufeff"==d.substring(0,
1)&&(this.cursor=1);var a=this.qa(d);a[0]>=this.cursor&&(a=a[1],this.ya(d.substring(this.cursor,a)),this.cursor=a);f.U()&&(this.log("request.isDone(). reopening the connection"),this.v(this.interval))}else this.readyState!==this.CLOSED&&(this.log("this.readyState !== this.CLOSED"),this.v(this.interval))},ya:function(f){f=this.cache+this.sa(f);f=f.split("\n\n");var a,g,b,h,c;for(a=0;a<f.length-1;a++){b="message";h=[];parts=f[a].split("\n");for(g=0;g<parts.length;g++)c=this.Ba(parts[g]),0==c.indexOf("event")?
b=c.replace(/event:?\s*/,""):0==c.indexOf("retry")?(c=parseInt(c.replace(/retry:?\s*/,"")),isNaN(c)||(this.interval=c)):0==c.indexOf("data")?h.push(c.replace(/data:?\s*/,"")):0==c.indexOf("id:")?this.lastEventId=c.replace(/id:?\s*/,""):0==c.indexOf("id")&&(this.lastEventId=null);h.length&&this.dispatchEvent(b,new e(b,h.join("\n"),this.lastEventId))}this.cache=f[f.length-1]},dispatchEvent:function(f,a){var g=this["_"+f+"Handlers"];if(g)for(var b=0;b<g.length;b++)g[b].call(this,a);this["on"+f]&&this["on"+
f].call(this,a)},addEventListener:function(f,a){this["_"+f+"Handlers"]||(this["_"+f+"Handlers"]=[]);this["_"+f+"Handlers"].push(a)},s:null,i:null,lastEventId:null,cache:"",cursor:0,readyState:0,Z:function(f,a){var g=[];if(a){var b,e,c=encodeURIComponent;for(b in a)a.hasOwnProperty(b)&&(e=c(b)+"="+c(a[b]),g.push(e))}return 0<g.length?-1==f.indexOf("?")?f+"?"+g.join("&"):f+"&"+g.join("&"):f},qa:function(f){var a=f.lastIndexOf("\n\n"),b=f.lastIndexOf("\r\r");f=f.lastIndexOf("\r\n\r\n");return f>Math.max(a,
b)?[f,f+4]:[Math.max(a,b),Math.max(a,b)+2]},Ba:function(a){return a.replace(/^(\s|\u00A0)+|(\s|\u00A0)+$/g,"")},sa:function(a){return a.replace(/\r\n|\r/g,"\n")}};if(window.XDomainRequest&&window.XMLHttpRequest&&void 0===(new XMLHttpRequest).responseType){h.g="IE_8-9";var a=h.prototype.P;a.$=null;a.u.evs_preamble=2056;h.prototype.o=function(a){this.b=request=new XDomainRequest;request.onprogress=function(){request.L=!0;a.A()};request.onload=function(){this.H=!0;a.A()};request.onerror=function(){this.h=
!0;a.readyState=a.CLOSED;a.dispatchEvent("error",{type:"error",data:"XDomainRequest error"})};request.ontimeout=function(){this.h=!0;a.readyState=a.CLOSED;a.dispatchEvent("error",{type:"error",data:"XDomainRequest timed out"})};var d={};if(a.u){var b=a.u,e;for(e in b)b.hasOwnProperty(e)&&(d[e]=b[e]);a.lastEventId&&(d.evs_last_event_id=a.lastEventId)}request.open("GET",a.Z(a.URL,d));request.send()};h.prototype.o.prototype={b:null,L:!1,H:!1,h:!1,V:function(){return this.b.L},U:function(){return this.b.H},
T:function(){return this.b.h},S:function(){var a="";try{a=this.b.responseText||""}catch(d){}return a},abort:function(){this.b&&this.b.abort()}}}else h.g="XHR",h.prototype.o=function(a){this.b=request=new XMLHttpRequest;a.i=this;request.onreadystatechange=function(){1<request.readyState&&a.readyState!=a.CLOSED&&(200==request.status||300<=request.status&&400>request.status?a.A():(request.h=!0,a.readyState=a.CLOSED,a.dispatchEvent("error",{type:"error",data:"The server responded with "+request.status}),
a.close()))};request.onprogress=function(){};request.open("GET",a.Z(a.URL,a.u),!0);var d=a.$,b;for(b in d)d.hasOwnProperty(b)&&request.setRequestHeader(b,d[b]);a.lastEventId&&request.setRequestHeader("Last-Event-Id",a.lastEventId);request.send()},h.prototype.o.prototype={b:null,h:!1,V:function(){return 2<=this.b.readyState},U:function(){return 4==this.b.readyState},T:function(){return this.h||400<=this.b.status},S:function(){var a="";try{a=this.b.responseText||""}catch(b){}return a},abort:function(){this.b&&
this.b.abort()}};b[c]=h}})(this);var k={g:function(b,e,c){e=e.split(".");for(var h=0;h<e.length-1;h++)b=b[e[h]];this.a(b,e[e.length-1],c)},a:function(b,e,c){b[e]=c}};var Logger=function(){function b(b,a){return b.replace(/{(\d+)}/g,function(b,d){var g;if(a[d]&&"object"===typeof a[d]&&a[d]instanceof Error)try{g=a[d].message,a[d].stack&&e.error(a[d].stack)}catch(c){g=a[d]}else if(a[d]&&"object"===typeof a[d])try{a[d].toString!==Object.prototype.toString?g=a[d].toString():g=JSON.stringify(a[d])}catch(h){g=a[d]}else a[d]&&"function"===typeof a[d]?g="function":g=a[d]?a[d]:b;g=""+g;return g.substring(0,Math.min(500,g.length))})}var e=window.console,c=2;return{aa:3,
ba:2,ca:1,ERROR:0,za:function(b){c=b},debug:function(){3<=c&&e&&e.log&&e.log(b(arguments[0],Array.prototype.slice.call(arguments,1)))},info:function(){2<=c&&e&&e.info&&e.info(b(arguments[0],Array.prototype.slice.call(arguments,1)))},warn:function(){1<=c&&e&&e.warn&&e.warn(b(arguments[0],Array.prototype.slice.call(arguments,1)))},error:function(){0<=c&&e&&e.error&&e.error(b(arguments[0],Array.prototype.slice.call(arguments,1)))}}}();var Preconditions=function(b){return{c:function(b,c){if("undefined"===typeof b||null===b){if(c)throw Error(c);throw Error("value cannot be null");}return b},g:function(e,c){this.c(e,"functionName cannot be null");this.c(c,"message cannot be null");b.warn("Deprecated: function '{0}' is deprecated because '{1}'.",e,c)},ma:function(b,c){if(!b){if(c)throw Error(c);throw Error("expression is not valid");}},la:function(b,c){if(!b){if(c)throw Error(c);throw Error("expression is not valid");}}}}(Logger);function l(b){Preconditions.c(b,"bind cannot be null");this.da=b;this.w=[]}l.prototype={m:function(){for(var b=this.w.slice(),e=0,c=b.length;e<c;e++)try{var h=b[e];h&&h.apply(this.da,arguments)}catch(a){Logger.error("Unable to forward event: {0}",a)}},add:function(b){Preconditions.c(b,"listener cannot be null");Preconditions.ma(-1==this.w.indexOf(b),"listener already exists");this.w.push(b)}};function StreamdataEventSource(b,e,c,h){Preconditions.c(b,"url cannot be null.");Preconditions.c(e,"appToken cannot be null.");Preconditions.la(null===h||void 0===h||h.hasOwnProperty("signUrl"),"authStrategy does not implement signUrl() function.");c=c||[];h=void 0===h?null:h;var a=this;a.streamdataConfig={PROTOCOL:"https://",HOST:"streamdata.motwin.net",PORT:""};a.f=null;a.j=!1;a.B=b;a.J=new l(a);a.D=new l(a);a.K=new l(a);a.G=new l(a);a.I=new l(a);a.ja=c;a.F={type:"UnknownError",status:1E3,message:"An error occured. Please check your console logs for more details.",
source:"server"};a.open=function(){Preconditions.c(a.B,"url cannot be null");a.close();var b=a.ha(a.B,a.ja);b&&(a.f=new EventSource(b),a.f.addEventListener("open",function(b){Logger.debug("SSE Stream Opened to "+a.B+"event: "+JSON.stringify(b));a.j=!0;a.J.m()}),a.f.addEventListener("error",function(b){Logger.debug("Error with SSE at "+b+": closing the stream.");a.f.close();a.j=!1;a.G.m(a.ea(b))}),a.f.addEventListener("data",function(b){Logger.debug("Received data:"+b.data);a.D.m(JSON.parse(b.data))}),
a.f.addEventListener("patch",function(b){Logger.debug("Received patch:"+b.data);a.K.m(JSON.parse(b.data))}),a.f.addEventListener("monitor",function(b){Logger.debug("Received monitor:"+b.data);a.I.m(JSON.parse(b.data))}));return this};a.close=function(){a.j&&null!==a.f&&(Logger.info("Closing the SSE Stream."),a.f.close(),a.j=!1);return this};a.ha=function(b,d){Preconditions.c(b,"url cannot be null");d=d||[];var g=document.createElement("a");g.href=b;var c=/\/\/(.*@)/g.exec(b),c=c?c=c[1]:"",g=g.protocol+
"//"+c+g.hostname+("0"!=g.port&&""!=g.port&&"80"!=g.port&&"443"!=g.port?":"+g.port:"")+(0==g.pathname.indexOf("/")?"":"/")+g.pathname+g.search,g=null===h?g:h.signUrl(g),c=a.ga(d),e="";0<c.length&&(e=document.createElement("a"),e.href=g,e=(-1===e.search.indexOf("?")?"?":"&")+c.join("&"));g=a.streamdataConfig.PROTOCOL+a.streamdataConfig.HOST+(a.pa(a.streamdataConfig.PORT)?"":":")+a.streamdataConfig.PORT+"/"+g+e;Logger.debug("converted url :"+g);return g};a.ga=function(b){b=b||[];b=a.fa(b);b.push("X-Sd-Token="+
encodeURIComponent(e));return b};a.fa=function(a){a=a||[];return a.map(function(a){return"X-Sd-Header="+encodeURIComponent(a)})};a.ea=function(b){Preconditions.c(b,"event cannot be null");var d=a.F;try{var c=JSON.parse(b.data);d.type=c.cause;d.message=c.message;d.status=c.status}catch(e){d=a.F}d.source="server";console.log(JSON.stringify(d));return new StreamdataError(d.type,d.message,d.status,d.source,!0)};a.pa=function(a){return!a||0===a.length}}
StreamdataEventSource.prototype={wa:function(b){Preconditions.c(b,"listener cannot be null");this.J.add(b);return this},ua:function(b){Preconditions.c(b,"listener cannot be null");this.G.add(b);return this},ta:function(b){Preconditions.c(b,"listener cannot be null");this.D.add(b);return this},xa:function(b){Preconditions.c(b,"listener cannot be null");this.K.add(b);return this},va:function(b){Preconditions.c(b,"listener cannot be null");this.I.add(b);return this},oa:function(){return this.j}};function StreamdataError(b,e,c,h,a){this.g=h;this.R=b;this.M=e;this.na=a||!1;this.N=c;k.a(this,"source",this.g);k.a(this,"type",this.R);k.a(this,"message",this.M);k.a(this,"status",this.N)}StreamdataError.prototype={isFatal:function(){return this.na},isServer:function(){return"server"==this.g},isClient:function(){return"client"==this.g},getMessage:function(){return this.M},getStatus:function(){return this.N},getType:function(){return this.R}};var streamdataio=new function(){};k.a(streamdataio,"Logger",Logger);k.a(Logger,"DEBUG",Logger.aa);k.a(Logger,"INFO",Logger.ba);k.a(Logger,"WARN",Logger.ca);k.a(Logger,"ERROR",Logger.ERROR);k.a(Logger,"setLevel",Logger.za);k.a(Logger,"debug",Logger.debug);k.a(Logger,"info",Logger.info);k.a(Logger,"warn",Logger.warn);k.a(Logger,"error",Logger.error);
k.a(streamdataio,"createEventSource",function(b,e,c,h){Preconditions.c(b,"url cannot be null");e=e||[];h=h||null;0!=b.lastIndexOf("http://",0)&&0!=b.lastIndexOf("https://",0)&&(b="http://"+b,Logger.warn("url has no default protocol defined. Add http:// as a default protocol."));return new StreamdataEventSource(b,e,c,h)});k.a(StreamdataError.prototype,"isFatal",StreamdataError.prototype.isFatal);k.a(StreamdataError.prototype,"isServer",StreamdataError.prototype.isServer);
k.a(StreamdataError.prototype,"isClient",StreamdataError.prototype.isClient);k.a(StreamdataError.prototype,"getMessage",StreamdataError.prototype.getMessage);k.a(StreamdataError.prototype,"getStatus",StreamdataError.prototype.getStatus);k.a(StreamdataError.prototype,"getType",StreamdataError.prototype.getType);k.a(StreamdataEventSource.prototype,"open",StreamdataEventSource.prototype.connect);k.a(StreamdataEventSource.prototype,"onOpen",StreamdataEventSource.prototype.wa);
k.a(StreamdataEventSource.prototype,"onError",StreamdataEventSource.prototype.ua);k.a(StreamdataEventSource.prototype,"onData",StreamdataEventSource.prototype.ta);k.a(StreamdataEventSource.prototype,"onPatch",StreamdataEventSource.prototype.xa);k.a(StreamdataEventSource.prototype,"onMonitor",StreamdataEventSource.prototype.va);k.a(StreamdataEventSource.prototype,"isConnected",StreamdataEventSource.prototype.oa);
